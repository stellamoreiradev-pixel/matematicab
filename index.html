<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Matem√°tica ‚Äî Dom√≠nio Total</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ============================================
   DESIGN SYSTEM ‚Äî TEMA CLARO EDUCACIONAL
   ============================================ */
:root {
  /* Cores principais */
  --primary: #6366F1;
  --primary-light: #818CF8;
  --primary-lighter: #E0E7FF;
  --primary-dark: #4F46E5;
  
  --secondary: #10B981;
  --secondary-light: #34D399;
  --secondary-lighter: #D1FAE5;
  
  --accent: #F59E0B;
  --accent-light: #FCD34D;
  --accent-lighter: #FEF3C7;
  
  --danger: #EF4444;
  --danger-light: #FCA5A5;
  --danger-lighter: #FEE2E2;
  
  /* Neutros */
  --bg-page: #F9FAFB;
  --bg-card: #FFFFFF;
  --bg-subtle: #F3F4F6;
  --bg-hover: #F9FAFB;
  
  --border: #E5E7EB;
  --border-light: #F3F4F6;
  
  --text-primary: #111827;
  --text-secondary: #6B7280;
  --text-muted: #9CA3AF;
  --text-inverse: #FFFFFF;
  
  /* Sombras */
  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
  --shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  
  /* Espa√ßamento */
  --radius: 16px;
  --radius-sm: 10px;
  --radius-full: 9999px;
  
  --transition: 0.2s ease;
}

/* ============================================
   RESET & BASE
   ============================================ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { scroll-behavior: smooth; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg-page);
  color: var(--text-primary);
  line-height: 1.6;
  min-height: 100vh;
  font-size: 15px;
  -webkit-font-smoothing: antialiased;
}

/* ============================================
   LAYOUT
   ============================================ */
.app {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

header {
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  padding: 1rem 1.5rem;
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-content {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
}

.logo {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.logo-icon {
  width: 42px;
  height: 42px;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  font-weight: 700;
  color: white;
}

.logo-text h1 {
  font-size: 1.125rem;
  font-weight: 700;
  color: var(--text-primary);
}

.logo-text span {
  font-size: 0.75rem;
  color: var(--text-muted);
  font-weight: 500;
}

nav {
  display: flex;
  gap: 0.5rem;
  background: var(--bg-subtle);
  padding: 0.375rem;
  border-radius: var(--radius-sm);
}

nav button {
  background: transparent;
  border: none;
  color: var(--text-secondary);
  padding: 0.5rem 1rem;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.875rem;
  font-weight: 500;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

nav button:hover {
  color: var(--text-primary);
  background: var(--bg-card);
}

nav button.active {
  background: var(--bg-card);
  color: var(--primary);
  box-shadow: var(--shadow-sm);
}

main {
  flex: 1;
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem 1.5rem;
  width: 100%;
}

/* ============================================
   CARDS
   ============================================ */
.card {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 1.5rem;
  box-shadow: var(--shadow);
  border: 1px solid var(--border-light);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.25rem;
}

.card-title {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.card-title .icon {
  font-size: 1.25rem;
}

.card-subtitle {
  font-size: 0.875rem;
  color: var(--text-muted);
  margin-top: 0.25rem;
}

/* ============================================
   BUTTONS
   ============================================ */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.625rem 1.25rem;
  border-radius: var(--radius-sm);
  border: none;
  cursor: pointer;
  font-size: 0.875rem;
  font-weight: 500;
  transition: var(--transition);
  font-family: inherit;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.btn-secondary {
  background: var(--bg-subtle);
  color: var(--text-primary);
  border: 1px solid var(--border);
}

.btn-secondary:hover {
  background: var(--bg-hover);
  border-color: var(--text-muted);
}

.btn-ghost {
  background: transparent;
  color: var(--text-secondary);
}

.btn-ghost:hover {
  background: var(--bg-subtle);
  color: var(--text-primary);
}

.btn-success {
  background: var(--secondary);
  color: white;
}

.btn-success:hover {
  background: #059669;
}

.btn-danger {
  background: var(--danger);
  color: white;
}

.btn-sm {
  padding: 0.375rem 0.75rem;
  font-size: 0.8125rem;
}

.btn-xs {
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
}

/* ============================================
   TAGS & BADGES
   ============================================ */
.tag {
  display: inline-flex;
  align-items: center;
  padding: 0.25rem 0.625rem;
  border-radius: var(--radius-full);
  font-size: 0.75rem;
  font-weight: 500;
}

.tag-default { background: var(--bg-subtle); color: var(--text-secondary); }
.tag-primary { background: var(--primary-lighter); color: var(--primary); }
.tag-success { background: var(--secondary-lighter); color: #047857; }
.tag-warning { background: var(--accent-lighter); color: #B45309; }
.tag-danger { background: var(--danger-lighter); color: var(--danger); }

.dominio-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  border-radius: var(--radius-full);
  font-size: 0.8125rem;
  font-weight: 600;
}

.dominio-0 { background: var(--danger-lighter); color: var(--danger); }
.dominio-1 { background: #FFEDD5; color: #C2410C; }
.dominio-2 { background: var(--accent-lighter); color: #B45309; }
.dominio-3 { background: var(--primary-lighter); color: var(--primary); }
.dominio-4 { background: var(--secondary-lighter); color: #047857; }

/* ============================================
   PROGRESS BAR
   ============================================ */
.progress-bar {
  height: 8px;
  background: var(--bg-subtle);
  border-radius: var(--radius-full);
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  border-radius: var(--radius-full);
  transition: width 0.4s ease;
}

.progress-fill.primary { background: linear-gradient(90deg, var(--primary), var(--primary-light)); }
.progress-fill.success { background: linear-gradient(90deg, var(--secondary), var(--secondary-light)); }
.progress-fill.warning { background: linear-gradient(90deg, var(--accent), var(--accent-light)); }

/* ============================================
   FORMS
   ============================================ */
input, select, textarea {
  width: 100%;
  padding: 0.75rem 1rem;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 0.9375rem;
  color: var(--text-primary);
  font-family: inherit;
  transition: var(--transition);
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px var(--primary-lighter);
}

label {
  display: block;
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: 0.5rem;
}

.form-group { margin-bottom: 1.25rem; }
.form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; }

/* ============================================
   WELCOME BANNER
   ============================================ */
.welcome-banner {
  background: linear-gradient(135deg, var(--primary-lighter), #F5F3FF);
  border: 1px solid #C7D2FE;
  border-radius: var(--radius);
  padding: 1.25rem 1.5rem;
  margin-bottom: 2rem;
}

.welcome-banner h2 {
  font-size: 1rem;
  font-weight: 600;
  color: var(--primary);
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.welcome-banner p {
  font-size: 0.9375rem;
  color: var(--text-secondary);
  line-height: 1.6;
}

/* ============================================
   STATS GRID
   ============================================ */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.stat-card {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 1.25rem;
  box-shadow: var(--shadow);
  border: 1px solid var(--border-light);
  text-align: center;
}

.stat-card.featured {
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  border: none;
}

.stat-card.featured .stat-value,
.stat-card.featured .stat-label { color: white; }

.stat-value {
  font-size: 1.75rem;
  font-weight: 700;
  color: var(--text-primary);
  line-height: 1.2;
}

.stat-label {
  font-size: 0.8125rem;
  color: var(--text-muted);
  margin-top: 0.375rem;
  font-weight: 500;
}

/* ============================================
   DASHBOARD GRID
   ============================================ */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 1.5rem;
}

/* ============================================
   FASE/MODULE PROGRESS
   ============================================ */
.fase-progress {
  margin-bottom: 1rem;
}

.fase-progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.fase-progress-header strong {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.fase-progress-header span {
  font-size: 0.8125rem;
  color: var(--text-muted);
}

.priority-badge {
  background: var(--accent-lighter);
  color: #B45309;
  font-size: 0.6875rem;
  padding: 0.125rem 0.5rem;
  border-radius: var(--radius-full);
  font-weight: 600;
}

/* ============================================
   REVIEW QUEUE
   ============================================ */
.review-info {
  background: var(--bg-subtle);
  border-radius: var(--radius-sm);
  padding: 0.875rem 1rem;
  margin-bottom: 1rem;
  font-size: 0.875rem;
  color: var(--text-secondary);
  border-left: 3px solid var(--primary);
}

.review-item, .today-item {
  display: flex;
  align-items: center;
  gap: 0.875rem;
  padding: 1rem;
  background: var(--bg-subtle);
  border-radius: var(--radius-sm);
  margin-bottom: 0.625rem;
  transition: var(--transition);
}

.review-item:hover, .today-item:hover {
  background: var(--bg-hover);
  box-shadow: var(--shadow-sm);
}

.review-item.overdue {
  background: var(--danger-lighter);
  border-left: 3px solid var(--danger);
}

.today-item {
  border-left: 3px solid var(--primary);
}

.review-item .info, .today-item .info {
  flex: 1;
  min-width: 0;
}

.review-item .title, .today-item .title {
  font-size: 0.9375rem;
  font-weight: 500;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.review-item .meta, .today-item .meta {
  font-size: 0.8125rem;
  color: var(--text-muted);
  margin-top: 0.25rem;
}

.review-item .actions, .today-item .actions {
  display: flex;
  gap: 0.375rem;
}

/* ============================================
   TODAY CONFIG
   ============================================ */
.today-config {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.today-config select {
  width: auto;
  padding: 0.5rem 0.75rem;
  font-size: 0.875rem;
}

/* ============================================
   FILTERS BAR
   ============================================ */
.filters-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  padding: 1rem;
  background: var(--bg-card);
  border-radius: var(--radius);
  border: 1px solid var(--border-light);
  margin-bottom: 1.5rem;
  box-shadow: var(--shadow-sm);
}

.filters-bar input, .filters-bar select {
  flex: 1;
  min-width: 150px;
  padding: 0.625rem 1rem;
}

.filters-bar .search-input {
  min-width: 200px;
}

/* ============================================
   TRILHA (TRACK)
   ============================================ */
.fase-section {
  margin-bottom: 1.5rem;
}

.fase-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.25rem;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  cursor: pointer;
  transition: var(--transition);
  margin-bottom: 0.75rem;
}

.fase-header:hover {
  box-shadow: var(--shadow-md);
  border-color: var(--primary-lighter);
}

.fase-header.priority {
  border-left: 4px solid var(--accent);
}

.fase-header h3 {
  font-size: 0.9375rem;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 0.625rem;
}

.fase-header .stats {
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 0.875rem;
  color: var(--text-muted);
}

.fase-header .toggle-icon {
  color: var(--text-muted);
  font-size: 0.875rem;
}

.fase-content {
  display: none;
  padding-left: 1rem;
}

.fase-content.open {
  display: block;
}

.modulo-section {
  margin-bottom: 0.75rem;
}

.modulo-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.875rem 1rem;
  background: var(--bg-subtle);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: var(--transition);
}

.modulo-header:hover {
  background: var(--bg-hover);
}

.modulo-header h4 {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-secondary);
}

.modulo-content {
  display: none;
  padding: 0.5rem 0 0.5rem 1rem;
}

.modulo-content.open {
  display: block;
}

.item-row {
  display: grid;
  grid-template-columns: auto 1fr auto auto auto auto;
  gap: 0.75rem;
  align-items: center;
  padding: 0.875rem 1rem;
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-sm);
  margin-bottom: 0.5rem;
  cursor: pointer;
  transition: var(--transition);
}

.item-row:hover {
  border-color: var(--primary-lighter);
  box-shadow: var(--shadow-sm);
}

.item-row .checkbox {
  width: 22px;
  height: 22px;
  border: 2px solid var(--border);
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
}

.item-row.done .checkbox {
  background: var(--secondary);
  border-color: var(--secondary);
  color: white;
}

.item-row.done .checkbox::after {
  content: '‚úì';
  font-size: 0.75rem;
  font-weight: bold;
}

.item-row .nome {
  font-size: 0.9375rem;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.item-row .fonte {
  font-size: 0.75rem;
  color: var(--text-muted);
  background: var(--bg-subtle);
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
}

.item-row .questoes {
  font-size: 0.8125rem;
  color: var(--text-muted);
  display: flex;
  gap: 0.5rem;
}

.item-row .questoes .ok { color: var(--secondary); }
.item-row .questoes .err { color: var(--danger); }

/* ============================================
   EXERCISES
   ============================================ */
.exercise-form {
  max-width: 560px;
}

.history-item {
  display: grid;
  grid-template-columns: 80px 1fr auto;
  gap: 1rem;
  align-items: center;
  padding: 1rem;
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-sm);
  margin-bottom: 0.625rem;
}

.history-item .date {
  font-size: 0.8125rem;
  color: var(--text-muted);
}

.history-item .result {
  display: flex;
  gap: 0.5rem;
  font-size: 0.875rem;
}

/* ============================================
   GOALS
   ============================================ */
.week-info {
  background: var(--bg-subtle);
  border-radius: var(--radius);
  padding: 1rem 1.25rem;
  margin-bottom: 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.9375rem;
  color: var(--text-secondary);
}

.goals-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.goal-card {
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-radius: var(--radius);
  padding: 1.5rem;
  box-shadow: var(--shadow);
}

.goal-card h4 {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-muted);
  margin-bottom: 0.75rem;
}

.goal-card .value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--text-primary);
}

.goal-card .meta-info {
  font-size: 0.8125rem;
  color: var(--text-muted);
  margin-top: 0.375rem;
}

.goal-card .progress-bar {
  margin-top: 0.75rem;
}

.auto-goals {
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-radius: var(--radius);
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  box-shadow: var(--shadow);
}

.auto-goals h4 {
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.auto-goals p {
  font-size: 0.9375rem;
  color: var(--text-muted);
  margin-bottom: 1rem;
}

.time-buttons {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}

/* ============================================
   BACKUP
   ============================================ */
.backup-section {
  max-width: 560px;
}

.backup-buttons {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  margin-bottom: 1.5rem;
}

.danger-zone {
  background: var(--danger-lighter);
  border: 1px solid var(--danger-light);
  border-radius: var(--radius);
  padding: 1.5rem;
  margin-top: 2rem;
}

.danger-zone h3 {
  color: var(--danger);
  font-size: 1rem;
  margin-bottom: 0.5rem;
}

.danger-zone p {
  font-size: 0.9375rem;
  color: var(--text-secondary);
  margin-bottom: 1rem;
}

/* ============================================
   MODAL
   ============================================ */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(17, 24, 39, 0.5);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 1rem;
  opacity: 0;
  visibility: hidden;
  transition: var(--transition);
}

.modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.modal {
  background: var(--bg-card);
  border-radius: var(--radius);
  width: 100%;
  max-width: 480px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
  transform: translateY(20px) scale(0.95);
  transition: var(--transition);
}

.modal-overlay.active .modal {
  transform: translateY(0) scale(1);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.25rem 1.5rem;
  border-bottom: 1px solid var(--border);
}

.modal-header h3 {
  font-size: 1.0625rem;
  font-weight: 600;
}

.modal-close {
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 1.5rem;
  cursor: pointer;
  line-height: 1;
  padding: 0.25rem;
  border-radius: 6px;
  transition: var(--transition);
}

.modal-close:hover {
  background: var(--bg-subtle);
  color: var(--text-primary);
}

.modal-body {
  padding: 1.5rem;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 0.75rem;
  padding: 1rem 1.5rem;
  border-top: 1px solid var(--border);
  background: var(--bg-subtle);
  border-radius: 0 0 var(--radius) var(--radius);
}

.prereq-alert {
  background: var(--accent-lighter);
  border: 1px solid var(--accent-light);
  border-radius: var(--radius-sm);
  padding: 0.875rem;
  margin-bottom: 1.25rem;
  font-size: 0.875rem;
  color: #B45309;
}

.review-buttons {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin-top: 0.625rem;
}

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 768px) {
  header {
    padding: 0.75rem 1rem;
  }
  
  .header-content {
    flex-direction: column;
    align-items: stretch;
  }
  
  .logo {
    justify-content: center;
    margin-bottom: 0.75rem;
  }
  
  nav {
    overflow-x: auto;
    justify-content: center;
  }
  
  main {
    padding: 1.25rem 1rem;
  }
  
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .item-row {
    grid-template-columns: auto 1fr auto auto;
  }
  
  .item-row .questoes,
  .item-row .fonte {
    display: none;
  }
  
  .filters-bar {
    flex-direction: column;
  }
  
  .filters-bar input,
  .filters-bar select {
    width: 100%;
  }
}

/* ============================================
   UTILITIES
   ============================================ */
.page { display: none; }
.page.active { display: block; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.card { animation: fadeIn 0.3s ease; }

::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: var(--bg-page); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
</style>
</head>
<body>

<div class="app">
  <header>
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon">œÄ</div>
        <div class="logo-text">
          <h1>Matem√°tica</h1>
          <span>Dom√≠nio Total</span>
        </div>
      </div>
      <nav>
        <button class="active" data-page="dashboard">üìä Dashboard</button>
        <button data-page="trilha">üìö Trilha</button>
        <button data-page="exercicios">‚úèÔ∏è Exerc√≠cios</button>
        <button data-page="metas">üéØ Metas</button>
        <button data-page="backup">‚öôÔ∏è Config</button>
      </nav>
    </div>
  </header>

  <main>
    <!-- DASHBOARD -->
    <div id="page-dashboard" class="page active">
      <div class="welcome-banner">
        <h2>üöÄ Bem-vindo √† sua jornada!</h2>
        <p>Siga a <strong>Trilha</strong> na ordem sugerida, registre seus exerc√≠cios e acompanhe seu progresso. O painel <strong>Hoje</strong> mostra as tarefas mais importantes do dia!</p>
      </div>

      <div class="stats-grid" id="stats-grid"></div>

      <div class="dashboard-grid">
        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="card-title"><span class="icon">üìà</span> Progresso por Fase</h2>
              <p class="card-subtitle">Acompanhe sua evolu√ß√£o</p>
            </div>
          </div>
          <div id="fases-progress"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="card-title"><span class="icon">üîî</span> Fila de Revis√£o</h2>
              <p class="card-subtitle">Revis√µes programadas</p>
            </div>
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.875rem;">
              <input type="checkbox" id="filtro-vencidas" style="width: 18px; height: 18px;">
              S√≥ vencidas
            </label>
          </div>
          <div class="review-info">
            üí° <strong>Revis√£o espa√ßada:</strong> Agende revis√µes em 1, 7, 15 ou 30 dias. Marque "Feito" para reagendar automaticamente.
          </div>
          <div id="fila-revisao"></div>
        </div>

        <div class="card" style="grid-column: 1 / -1;">
          <div class="card-header">
            <div>
              <h2 class="card-title"><span class="icon">üìÖ</span> Hoje</h2>
              <p class="card-subtitle">Suas tarefas priorit√°rias</p>
            </div>
            <div class="today-config">
              <select id="hoje-tempo">
                <option value="30">30 min</option>
                <option value="60" selected>60 min</option>
                <option value="90">90 min</option>
                <option value="120">120 min</option>
              </select>
              <select id="hoje-qtd">
                <option value="5">5 tarefas</option>
                <option value="8" selected>8 tarefas</option>
                <option value="10">10 tarefas</option>
                <option value="12">12 tarefas</option>
              </select>
              <button class="btn btn-sm btn-primary" onclick="gerarHoje()">Gerar</button>
            </div>
          </div>
          <div id="lista-hoje"></div>
        </div>
      </div>
    </div>

    <!-- TRILHA -->
    <div id="page-trilha" class="page">
      <div class="filters-bar">
        <input type="text" id="filtro-busca" class="search-input" placeholder="üîç Buscar...">
        <select id="filtro-fase"><option value="">Todas as fases</option></select>
        <select id="filtro-status">
          <option value="">Todos status</option>
          <option value="nao-iniciado">N√£o iniciado</option>
          <option value="em-andamento">Em andamento</option>
          <option value="revisar">Revisar</option>
          <option value="concluido">Conclu√≠do</option>
        </select>
        <select id="filtro-dominio">
          <option value="">Todos dom√≠nios</option>
          <option value="0">0 ‚Äî Travo</option>
          <option value="1">1 ‚Äî C/ ajuda</option>
          <option value="2">2 ‚Äî F√°ceis</option>
          <option value="3">3 ‚Äî M√©dias</option>
          <option value="4">4 ‚Äî Domino</option>
        </select>
        <select id="filtro-fonte">
          <option value="">Todas fontes</option>
          <option value="Ferretto">Ferretto</option>
          <option value="Livro">Livro</option>
          <option value="Ambos">Ambos</option>
        </select>
        <select id="filtro-ordenar">
          <option value="trilha">Ordem da trilha</option>
          <option value="dominio-menor">Menor dom√≠nio</option>
          <option value="mais-erros">Mais erros</option>
          <option value="revisoes-vencidas">Revis√µes vencidas</option>
        </select>
      </div>
      <div id="trilha-lista"></div>
    </div>

    <!-- EXERC√çCIOS -->
    <div id="page-exercicios" class="page">
      <div class="card exercise-form">
        <div class="card-header">
          <h2 class="card-title"><span class="icon">‚úèÔ∏è</span> Registrar Exerc√≠cios</h2>
        </div>
        <div class="form-group">
          <label>Item da Trilha</label>
          <select id="ex-item"></select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Feitas</label>
            <input type="number" id="ex-feitas" min="0" value="10">
          </div>
          <div class="form-group">
            <label>Acertos</label>
            <input type="number" id="ex-acertos" min="0" value="0">
          </div>
          <div class="form-group">
            <label>Erros</label>
            <input type="number" id="ex-erros" min="0" value="0">
          </div>
        </div>
        <div class="form-group">
          <label>Erro t√≠pico (opcional)</label>
          <textarea id="ex-erro-tipico" rows="2" placeholder="Ex: Esqueci de inverter a fra√ß√£o..."></textarea>
        </div>
        <button class="btn btn-primary" onclick="registrarExercicio()">Salvar Exerc√≠cio</button>
      </div>

      <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
          <h2 class="card-title"><span class="icon">üìú</span> Hist√≥rico Recente</h2>
        </div>
        <div id="historico-lista"></div>
      </div>
    </div>

    <!-- METAS -->
    <div id="page-metas" class="page">
      <div class="week-info" id="week-info"></div>

      <div class="auto-goals">
        <h4>‚ö° Metas Autom√°ticas</h4>
        <p>Escolha seu tempo dispon√≠vel por dia e definiremos metas realistas:</p>
        <div class="time-buttons">
          <button class="btn btn-secondary" onclick="definirMetasAuto(30)">30 min/dia</button>
          <button class="btn btn-secondary" onclick="definirMetasAuto(60)">60 min/dia</button>
          <button class="btn btn-secondary" onclick="definirMetasAuto(90)">90 min/dia</button>
          <button class="btn btn-secondary" onclick="definirMetasAuto(120)">120 min/dia</button>
        </div>
      </div>

      <div class="goals-grid">
        <div class="goal-card">
          <h4>üìù Quest√µes por Semana</h4>
          <div class="form-group" style="margin-bottom: 0.5rem;">
            <input type="number" id="meta-questoes" min="0" value="50">
          </div>
          <div class="value" id="questoes-semana">0</div>
          <div class="meta-info">de <span id="meta-questoes-val">50</span></div>
          <div class="progress-bar"><div class="progress-fill primary" id="progress-questoes" style="width: 0%;"></div></div>
        </div>

        <div class="goal-card">
          <h4>‚úÖ Itens Conclu√≠dos</h4>
          <div class="form-group" style="margin-bottom: 0.5rem;">
            <input type="number" id="meta-concluidos" min="0" value="6">
          </div>
          <div class="value" id="concluidos-semana">0</div>
          <div class="meta-info">de <span id="meta-concluidos-val">6</span></div>
          <div class="progress-bar"><div class="progress-fill success" id="progress-concluidos" style="width: 0%;"></div></div>
        </div>

        <div class="goal-card">
          <h4>üîÑ Revis√µes por Semana</h4>
          <div class="form-group" style="margin-bottom: 0.5rem;">
            <input type="number" id="meta-revisoes" min="0" value="14">
          </div>
          <div class="value" id="revisoes-semana">0</div>
          <div class="meta-info">de <span id="meta-revisoes-val">14</span></div>
          <div class="progress-bar"><div class="progress-fill warning" id="progress-revisoes" style="width: 0%;"></div></div>
        </div>
      </div>

      <button class="btn btn-primary" onclick="salvarMetas()">üíæ Salvar Metas</button>
    </div>

    <!-- BACKUP -->
    <div id="page-backup" class="page">
      <div class="backup-section">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><span class="icon">üíæ</span> Backup & Restaura√ß√£o</h2>
          </div>
          <p style="color: var(--text-secondary); margin-bottom: 1rem;">
            Exporte seus dados para backup ou importe dados salvos anteriormente.
          </p>
          <div class="backup-buttons">
            <button class="btn btn-primary" onclick="exportarDados()">üì§ Exportar JSON</button>
            <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">üì• Importar JSON</button>
            <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importarDados(event)">
          </div>
        </div>

        <div class="danger-zone">
          <h3>‚ö†Ô∏è Zona de Perigo</h3>
          <p>Esta a√ß√£o apagar√° todos os seus dados permanentemente.</p>
          <button class="btn btn-danger" onclick="resetarDados()">üóëÔ∏è Resetar Tudo</button>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modal-editar">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modal-titulo">Editar Item</h3>
      <button class="modal-close" onclick="fecharModal()">√ó</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="edit-id">
      <div id="prereq-warning" class="prereq-alert" style="display: none;"></div>
      
      <div class="form-group">
        <label>Status</label>
        <select id="edit-status">
          <option value="nao-iniciado">N√£o iniciado</option>
          <option value="em-andamento">Em andamento</option>
          <option value="revisar">Revisar</option>
          <option value="concluido">Conclu√≠do</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Dom√≠nio (0-4)</label>
        <select id="edit-dominio">
          <option value="0">0 ‚Äî Travo / n√£o sei</option>
          <option value="1">1 ‚Äî Entendo com ajuda</option>
          <option value="2">2 ‚Äî Fa√ßo quest√µes f√°ceis</option>
          <option value="3">3 ‚Äî Fa√ßo m√©dias e explico</option>
          <option value="4">4 ‚Äî Domino e acerto em prova</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Erro T√≠pico</label>
        <textarea id="edit-erro" rows="2" placeholder="Anote seus erros mais comuns..."></textarea>
      </div>
      
      <div class="form-group">
        <label>Agendar Revis√£o</label>
        <div class="review-buttons">
          <button class="btn btn-xs btn-secondary" onclick="agendarRevisao(1)">1 dia</button>
          <button class="btn btn-xs btn-secondary" onclick="agendarRevisao(7)">7 dias</button>
          <button class="btn btn-xs btn-secondary" onclick="agendarRevisao(15)">15 dias</button>
          <button class="btn btn-xs btn-secondary" onclick="agendarRevisao(30)">30 dias</button>
          <button class="btn btn-xs btn-ghost" onclick="limparRevisao()">Limpar</button>
        </div>
        <small id="edit-revisao-info" style="color: var(--text-muted); margin-top: 0.5rem; display: block;"></small>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="salvarEdicao()">Salvar</button>
    </div>
  </div>
</div>

<script>
/* ============================================
   TRILHA DE CONTE√öDO
   ============================================ */
const TRILHA = [
  {
    id: 1, nome: "FASE 1 ‚Äî Fundamentos e Linguagem", prioridade: 3,
    modulos: [
      { id: 1, nome: "M√≥dulo 1: Linguagem Matem√°tica", itens: [
        { nome: "Linguagem matem√°tica (s√≠mbolos, leitura)", fonte: "Livro" },
        { nome: "N√∫meros famosos (introdu√ß√£o)", fonte: "Livro" },
        { nome: "Problemas simples iniciais", fonte: "Livro" }
      ]},
      { id: 2, nome: "M√≥dulo 2: Sistema de Numera√ß√£o", itens: [
        { nome: "Sistema de numera√ß√£o decimal", fonte: "Ferretto" },
        { nome: "Algarismos, valor absoluto e relativo", fonte: "Livro" },
        { nome: "Classes e ordens; escrever por extenso", fonte: "Livro" },
        { nome: "Numerais romanos", fonte: "Livro" }
      ]},
      { id: 3, nome: "M√≥dulo 3: Conjuntos Num√©ricos", itens: [
        { nome: "Naturais", fonte: "Ferretto" },
        { nome: "Inteiros", fonte: "Ferretto" },
        { nome: "Racionais", fonte: "Ferretto" },
        { nome: "Decimais exatos e d√≠zimas peri√≥dicas", fonte: "Ferretto" },
        { nome: "Irracionais", fonte: "Ferretto" },
        { nome: "Reais", fonte: "Ferretto" },
        { nome: "Revis√£o: tipos de n√∫mero e exemplos", fonte: "Ambos" }
      ]}
    ]
  },
  {
    id: 2, nome: "FASE 2 ‚Äî Aritm√©tica com Flu√™ncia", prioridade: 4,
    modulos: [
      { id: 4, nome: "M√≥dulo 4: Calcule R√°pido", itens: [
        { nome: "Estrat√©gias de soma/subtra√ß√£o r√°pida", fonte: "Livro" },
        { nome: "Multiplica√ß√£o mental b√°sica", fonte: "Livro" },
        { nome: "Divis√£o exata e prova real", fonte: "Livro" },
        { nome: "Quadrados perfeitos e cubos", fonte: "Livro" },
        { nome: "A prova dos 9", fonte: "Livro" },
        { nome: "Zero e um / propriedades", fonte: "Livro" }
      ]},
      { id: 5, nome: "M√≥dulo 5: As 4 Opera√ß√µes", itens: [
        { nome: "Adi√ß√£o e subtra√ß√£o", fonte: "Ferretto" },
        { nome: "Multiplica√ß√£o", fonte: "Ferretto" },
        { nome: "Divis√£o", fonte: "Ferretto" },
        { nome: "Termos das opera√ß√µes e problemas", fonte: "Livro" },
        { nome: "Propriedades: fechamento, comutativa, associativa, distributiva", fonte: "Livro" },
        { nome: "Express√µes com as quatro opera√ß√µes", fonte: "Ambos" },
        { nome: "Express√µes num√©ricas Parte 1", fonte: "Ferretto" },
        { nome: "Express√µes num√©ricas Parte 2", fonte: "Ferretto" }
      ]}
    ]
  },
  {
    id: 3, nome: "FASE 3 ‚Äî Divisibilidade, Primos, MMC/MDC", prioridade: 4,
    modulos: [
      { id: 6, nome: "M√≥dulo 6: M√∫ltiplos, Divisores e Fatora√ß√£o", itens: [
        { nome: "M√∫ltiplos e divisores", fonte: "Ferretto" },
        { nome: "Crit√©rios de divisibilidade", fonte: "Ambos" },
        { nome: "N√∫meros primos e compostos", fonte: "Ferretto" },
        { nome: "Crivo de Erat√≥stenes", fonte: "Livro" },
        { nome: "Fatora√ß√£o de naturais", fonte: "Ambos" },
        { nome: "Divisores de um inteiro; n√∫mero de divisores", fonte: "Livro" },
        { nome: "MMC", fonte: "Ambos" },
        { nome: "MDC", fonte: "Ambos" },
        { nome: "Primos entre si; propriedades de MMC/MDC", fonte: "Livro" },
        { nome: "Problemas cl√°ssicos: ciclos, etc.", fonte: "Livro" }
      ]}
    ]
  },
  {
    id: 4, nome: "FASE 4 ‚Äî Fra√ß√µes e Decimais", prioridade: 5,
    modulos: [
      { id: 7, nome: "M√≥dulo 7: Fra√ß√µes", itens: [
        { nome: "Fra√ß√£o como divis√£o; nomenclatura", fonte: "Livro", prereq: "Divis√£o" },
        { nome: "Fra√ß√µes equivalentes e simplifica√ß√£o", fonte: "Livro" },
        { nome: "Tipos: pr√≥pria, impr√≥pria, mista, aparente", fonte: "Livro" },
        { nome: "Fra√ß√µes", fonte: "Ferretto" },
        { nome: "Opera√ß√µes com fra√ß√µes", fonte: "Ferretto" },
        { nome: "Express√µes com fra√ß√µes", fonte: "Livro" },
        { nome: "Pot√™ncia de fra√ß√£o", fonte: "Livro" },
        { nome: "Problemas cl√°ssicos com fra√ß√µes", fonte: "Livro" }
      ]},
      { id: 8, nome: "M√≥dulo 8: Decimais e D√≠zimas", itens: [
        { nome: "N√∫meros decimais; convers√µes fra√ß√£o‚Üîdecimal", fonte: "Livro", prereq: "Fra√ß√µes" },
        { nome: "Decimais exatos e d√≠zimas peri√≥dicas (refor√ßo)", fonte: "Ferretto" },
        { nome: "Fra√ß√£o geratriz", fonte: "Livro" },
        { nome: "Divis√£o com aproxima√ß√£o", fonte: "Livro" }
      ]}
    ]
  },
  {
    id: 5, nome: "FASE 5 ‚Äî Pot√™ncias e Ra√≠zes", prioridade: 4,
    modulos: [
      { id: 9, nome: "M√≥dulo 9: Potencia√ß√£o", itens: [
        { nome: "Potencia√ß√£o", fonte: "Ferretto" },
        { nome: "Propriedades de pot√™ncias", fonte: "Livro" },
        { nome: "Pot√™ncias de 10 e nota√ß√£o cient√≠fica", fonte: "Ambos" },
        { nome: "Comparando pot√™ncias", fonte: "Livro" },
        { nome: "Pot√™ncia de decimal e aplica√ß√µes", fonte: "Livro" }
      ]},
      { id: 10, nome: "M√≥dulo 10: Radicia√ß√£o", itens: [
        { nome: "Radicia√ß√£o: introdu√ß√£o", fonte: "Ferretto" },
        { nome: "Propriedades 1", fonte: "Ferretto" },
        { nome: "Propriedades 2", fonte: "Ferretto" },
        { nome: "Racionaliza√ß√£o de denominadores", fonte: "Ferretto" },
        { nome: "Quadrados perfeitos (revis√£o)", fonte: "Livro" }
      ]}
    ]
  },
  {
    id: 6, nome: "FASE 6 ‚Äî Medidas e Convers√µes", prioridade: 3,
    modulos: [
      { id: 11, nome: "M√≥dulo 11: SI e Sistema M√©trico", itens: [
        { nome: "Prefixos SI", fonte: "Ferretto" },
        { nome: "Unidades: comprimento, √°rea, volume, massa, capacidade", fonte: "Ferretto" },
        { nome: "Sistema monet√°rio / tempo", fonte: "Livro" },
        { nome: "Sistema de medidas (refor√ßo)", fonte: "Livro" }
      ]},
      { id: 12, nome: "M√≥dulo 12: Medidas Geom√©tricas", itens: [
        { nome: "Comprimento, √°rea, volume", fonte: "Livro" },
        { nome: "Elementos b√°sicos de plana e espacial", fonte: "Livro" }
      ]}
    ]
  },
  {
    id: 7, nome: "FASE 7 ‚Äî Raz√£o, Propor√ß√£o, Regra de Tr√™s", prioridade: 5,
    modulos: [
      { id: 13, nome: "M√≥dulo 13: Raz√µes e Propor√ß√µes", itens: [
        { nome: "Raz√£o e propor√ß√£o", fonte: "Ferretto", prereq: "Fra√ß√µes" },
        { nome: "Grandezas diretamente proporcionais", fonte: "Ferretto" },
        { nome: "Grandezas inversamente proporcionais", fonte: "Ferretto" },
        { nome: "Divis√£o proporcional direta", fonte: "Ferretto" },
        { nome: "Divis√£o proporcional inversa", fonte: "Ferretto" },
        { nome: "Divis√£o proporcional (refor√ßo)", fonte: "Ferretto" }
      ]},
      { id: 14, nome: "M√≥dulo 14: Regra de Tr√™s", itens: [
        { nome: "Regra de tr√™s simples direta", fonte: "Ferretto" },
        { nome: "Regra de tr√™s simples inversa", fonte: "Ferretto" },
        { nome: "Regra de tr√™s composta", fonte: "Ferretto" }
      ]},
      { id: 15, nome: "M√≥dulo 15: Escalas", itens: [
        { nome: "Escala", fonte: "Ferretto" },
        { nome: "Escalas m√©tricas", fonte: "Ferretto" }
      ]}
    ]
  },
  {
    id: 8, nome: "FASE 8 ‚Äî Porcentagem", prioridade: 5,
    modulos: [
      { id: 16, nome: "M√≥dulo 16: Porcentagem Completa", itens: [
        { nome: "Porcentagem como fra√ß√£o", fonte: "Livro", prereq: "Fra√ß√µes" },
        { nome: "Porcentagem Parte 1", fonte: "Ferretto" },
        { nome: "Porcentagem Parte 2", fonte: "Ferretto" },
        { nome: "Porcentagem Parte 3", fonte: "Ferretto" },
        { nome: "Aumentos e descontos", fonte: "Livro" },
        { nome: "Porcentagens combinadas / sucessivas", fonte: "Livro" },
        { nome: "Lucro, multa, juros como aplica√ß√£o", fonte: "Livro" }
      ]}
    ]
  },
  {
    id: 9, nome: "FASE 9 ‚Äî √Ålgebra e Equa√ß√µes", prioridade: 4,
    modulos: [
      { id: 17, nome: "M√≥dulo 17: Produtos Not√°veis e Fatora√ß√£o", itens: [
        { nome: "Produtos not√°veis Parte 1", fonte: "Ferretto" },
        { nome: "Produtos not√°veis Parte 2", fonte: "Ferretto" },
        { nome: "Fatora√ß√£o: fator comum", fonte: "Ferretto" },
        { nome: "Fatora√ß√£o: diferen√ßa de quadrados", fonte: "Ferretto" },
        { nome: "Fatora√ß√£o: trin√¥mio quadrado perfeito", fonte: "Ferretto" },
        { nome: "Fatora√ß√£o: trin√¥mio do segundo grau", fonte: "Ferretto" }
      ]},
      { id: 18, nome: "M√≥dulo 18: Equa√ß√µes e Sistemas", itens: [
        { nome: "No√ß√µes sobre equa√ß√µes", fonte: "Livro" },
        { nome: "Equa√ß√£o do 1¬∫ grau", fonte: "Ambos" },
        { nome: "Problemas com equa√ß√£o 1¬∫ grau", fonte: "Livro" },
        { nome: "Sistemas de equa√ß√£o 1¬∫ grau", fonte: "Livro" },
        { nome: "Equa√ß√£o do 2¬∫ grau", fonte: "Ferretto" }
      ]}
    ]
  },
  {
    id: 10, nome: "FASE 10 ‚Äî Conjuntos", prioridade: 3,
    modulos: [
      { id: 19, nome: "M√≥dulo 19: Teoria dos Conjuntos", itens: [
        { nome: "Conceitos e nota√ß√£o", fonte: "Livro" },
        { nome: "Subconjuntos", fonte: "Livro" },
        { nome: "Opera√ß√µes com conjuntos", fonte: "Livro" },
        { nome: "Diagrama de Venn", fonte: "Livro" },
        { nome: "N¬∫ de elementos, subconjuntos, conjunto das partes", fonte: "Livro" }
      ]}
    ]
  }
];

/* ============================================
   ESTADO
   ============================================ */
let estado = {
  itens: {},
  historico: [],
  metas: { questoes: 50, concluidos: 6, revisoes: 14 },
  semanaDados: { inicio: null, questoes: 0, concluidos: 0, revisoes: 0 }
};

/* ============================================
   INICIALIZA√á√ÉO
   ============================================ */
function inicializar() {
  carregarDados();
  inicializarItens();
  setupNavegacao();
  setupFiltros();
  setupMetas();
  renderizarTudo();
  document.getElementById('filtro-vencidas').addEventListener('change', renderizarFilaRevisao);
}

function carregarDados() {
  const dados = localStorage.getItem('mat-bb-v3');
  if (dados) estado = JSON.parse(dados);
  verificarSemana();
}

function salvarDados() {
  localStorage.setItem('mat-bb-v3', JSON.stringify(estado));
}

function inicializarItens() {
  let idx = 0;
  TRILHA.forEach(fase => {
    fase.modulos.forEach(modulo => {
      modulo.itens.forEach(item => {
        const key = `item_${idx}`;
        if (!estado.itens[key]) {
          estado.itens[key] = {
            id: key, idx, faseId: fase.id, faseNome: fase.nome, fasePrioridade: fase.prioridade,
            moduloId: modulo.id, moduloNome: modulo.nome, nome: item.nome, fonte: item.fonte,
            prereq: item.prereq || null, status: 'nao-iniciado', dominio: 0,
            questoesFeitas: 0, acertos: 0, erros: 0, erroTipico: '',
            dueAt: null, reviewCount: 0, lastReviewedAt: null, updatedAt: null
          };
        } else {
          estado.itens[key].faseNome = fase.nome;
          estado.itens[key].fasePrioridade = fase.prioridade;
          estado.itens[key].moduloNome = modulo.nome;
          estado.itens[key].nome = item.nome;
          estado.itens[key].fonte = item.fonte;
          estado.itens[key].prereq = item.prereq || null;
        }
        idx++;
      });
    });
  });
  salvarDados();
}

function verificarSemana() {
  const hoje = new Date();
  const diaSemana = hoje.getDay();
  const diff = (diaSemana === 0 ? -6 : 1) - diaSemana;
  const inicioSemana = new Date(hoje);
  inicioSemana.setDate(hoje.getDate() + diff);
  inicioSemana.setHours(0, 0, 0, 0);
  const inicioStr = inicioSemana.toISOString().split('T')[0];
  
  if (estado.semanaDados.inicio !== inicioStr) {
    estado.semanaDados = { inicio: inicioStr, questoes: 0, concluidos: 0, revisoes: 0 };
    salvarDados();
  }
}

function setupNavegacao() {
  document.querySelectorAll('nav button').forEach(btn => {
    btn.addEventListener('click', () => {
      const page = btn.dataset.page;
      document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(`page-${page}`).classList.add('active');
      if (page === 'dashboard') renderizarDashboard();
      if (page === 'trilha') renderizarTrilha();
      if (page === 'exercicios') renderizarExercicios();
      if (page === 'metas') renderizarMetas();
    });
  });
}

function setupFiltros() {
  const selectFase = document.getElementById('filtro-fase');
  TRILHA.forEach(f => {
    const opt = document.createElement('option');
    opt.value = f.id;
    opt.textContent = f.nome;
    selectFase.appendChild(opt);
  });
  
  ['filtro-busca', 'filtro-fase', 'filtro-status', 'filtro-dominio', 'filtro-fonte', 'filtro-ordenar'].forEach(id => {
    document.getElementById(id).addEventListener('input', renderizarTrilha);
    document.getElementById(id).addEventListener('change', renderizarTrilha);
  });
}

function setupMetas() {
  document.getElementById('meta-questoes').value = estado.metas.questoes;
  document.getElementById('meta-concluidos').value = estado.metas.concluidos;
  document.getElementById('meta-revisoes').value = estado.metas.revisoes;
}

function salvarMetas() {
  estado.metas.questoes = parseInt(document.getElementById('meta-questoes').value) || 50;
  estado.metas.concluidos = parseInt(document.getElementById('meta-concluidos').value) || 6;
  estado.metas.revisoes = parseInt(document.getElementById('meta-revisoes').value) || 14;
  salvarDados();
  renderizarMetas();
  alert('Metas salvas!');
}

function definirMetasAuto(tempo) {
  const configs = { 30: { questoes: 25, revisoes: 8, concluidos: 4 }, 60: { questoes: 50, revisoes: 14, concluidos: 6 }, 90: { questoes: 80, revisoes: 18, concluidos: 8 }, 120: { questoes: 110, revisoes: 22, concluidos: 10 } };
  const cfg = configs[tempo] || configs[60];
  
  const itens = Object.values(estado.itens);
  const dominioMedio = itens.length > 0 ? itens.reduce((a, i) => a + i.dominio, 0) / itens.length : 0;
  
  if (dominioMedio < 2) { cfg.questoes = Math.round(cfg.questoes * 1.2); cfg.revisoes = Math.round(cfg.revisoes * 1.3); }
  
  document.getElementById('meta-questoes').value = cfg.questoes;
  document.getElementById('meta-concluidos').value = cfg.concluidos;
  document.getElementById('meta-revisoes').value = cfg.revisoes;
  salvarMetas();
}

function renderizarTudo() {
  renderizarDashboard();
  renderizarTrilha();
  renderizarExercicios();
  renderizarMetas();
}

/* DASHBOARD */
function renderizarDashboard() {
  renderizarStats();
  renderizarFasesProgress();
  renderizarFilaRevisao();
  gerarHoje();
}

function renderizarStats() {
  const itens = Object.values(estado.itens);
  const total = itens.length;
  const concluidos = itens.filter(i => i.status === 'concluido').length;
  const emAndamento = itens.filter(i => i.status === 'em-andamento').length;
  const revisar = itens.filter(i => i.status === 'revisar').length;
  const dominioMedio = itens.length > 0 ? (itens.reduce((a, i) => a + i.dominio, 0) / itens.length).toFixed(1) : 0;
  const totalQuestoes = itens.reduce((a, i) => a + i.questoesFeitas, 0);
  const totalAcertos = itens.reduce((a, i) => a + i.acertos, 0);
  const taxaAcerto = totalQuestoes > 0 ? Math.round((totalAcertos / totalQuestoes) * 100) : 0;
  const progresso = total > 0 ? Math.round((concluidos / total) * 100) : 0;
  
  document.getElementById('stats-grid').innerHTML = `
    <div class="stat-card featured">
      <div class="stat-value">${progresso}%</div>
      <div class="stat-label">Progresso</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" style="color: var(--secondary);">${concluidos}</div>
      <div class="stat-label">Conclu√≠dos</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" style="color: var(--primary);">${emAndamento}</div>
      <div class="stat-label">Em andamento</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" style="color: var(--accent);">${revisar}</div>
      <div class="stat-label">Revisar</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" style="color: var(--primary);">${dominioMedio}</div>
      <div class="stat-label">Dom√≠nio M√©dio</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${totalQuestoes}</div>
      <div class="stat-label">Quest√µes</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" style="color: ${taxaAcerto >= 70 ? 'var(--secondary)' : 'var(--accent)'};">${taxaAcerto}%</div>
      <div class="stat-label">Taxa de Acerto</div>
    </div>
  `;
}

function renderizarFasesProgress() {
  const container = document.getElementById('fases-progress');
  let html = '';
  
  TRILHA.forEach(fase => {
    const itens = Object.values(estado.itens).filter(i => i.faseId === fase.id);
    const total = itens.length;
    const concluidos = itens.filter(i => i.status === 'concluido').length;
    const dominioMedio = itens.length > 0 ? (itens.reduce((a, i) => a + i.dominio, 0) / itens.length).toFixed(1) : 0;
    const progresso = total > 0 ? Math.round((concluidos / total) * 100) : 0;
    const prioTag = fase.prioridade === 5 ? '<span class="priority-badge">Prioridade</span>' : '';
    
    html += `
      <div class="fase-progress">
        <div class="fase-progress-header">
          <strong>${fase.nome.replace('FASE', 'F').split(' ‚Äî ')[0]} ${prioTag}</strong>
          <span>${concluidos}/${total} ‚Ä¢ D${dominioMedio}</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill ${progresso >= 80 ? 'success' : progresso >= 40 ? 'primary' : 'warning'}" style="width: ${progresso}%;"></div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function renderizarFilaRevisao() {
  const container = document.getElementById('fila-revisao');
  const apenasVencidas = document.getElementById('filtro-vencidas').checked;
  const agora = new Date();
  
  let comRevisao = Object.values(estado.itens)
    .filter(i => i.dueAt)
    .map(i => ({ ...i, dueDate: new Date(i.dueAt), vencida: new Date(i.dueAt) <= agora }))
    .sort((a, b) => a.dueDate - b.dueDate);
  
  if (apenasVencidas) comRevisao = comRevisao.filter(i => i.vencida);
  comRevisao = comRevisao.slice(0, 8);
  
  if (comRevisao.length === 0) {
    container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Nenhuma revis√£o agendada.</p>';
    return;
  }
  
  let html = '';
  comRevisao.forEach(i => {
    const diasAte = Math.ceil((i.dueDate - agora) / (1000 * 60 * 60 * 24));
    const diasTexto = diasAte <= 0 ? '‚ö†Ô∏è Vencida' : diasAte === 1 ? 'Amanh√£' : `Em ${diasAte}d`;
    
    html += `
      <div class="review-item ${i.vencida ? 'overdue' : ''}">
        <span class="dominio-badge dominio-${i.dominio}">${i.dominio}</span>
        <div class="info">
          <div class="title">${i.nome}</div>
          <div class="meta">${diasTexto} ‚Ä¢ ${i.reviewCount} revis√µes</div>
        </div>
        <div class="actions">
          <button class="btn btn-xs btn-secondary" onclick="marcarRevisaoFeita('${i.id}', 7)">+7d</button>
          <button class="btn btn-xs btn-secondary" onclick="marcarRevisaoFeita('${i.id}', 15)">+15d</button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function marcarRevisaoFeita(id, dias) {
  const item = estado.itens[id];
  if (!item) return;
  
  item.reviewCount++;
  item.lastReviewedAt = new Date().toISOString();
  item.dueAt = new Date(Date.now() + dias * 24 * 60 * 60 * 1000).toISOString();
  item.updatedAt = new Date().toISOString();
  estado.semanaDados.revisoes++;
  
  salvarDados();
  renderizarDashboard();
}

function gerarHoje() {
  const qtd = parseInt(document.getElementById('hoje-qtd').value) || 8;
  const container = document.getElementById('lista-hoje');
  const agora = new Date();
  
  const itens = Object.values(estado.itens);
  const fase4 = itens.filter(i => i.faseId === 4);
  const fase5 = itens.filter(i => i.faseId === 5);
  const dominioFase4 = fase4.length > 0 ? fase4.reduce((a, i) => a + i.dominio, 0) / fase4.length : 0;
  const dominioFase5 = fase5.length > 0 ? fase5.reduce((a, i) => a + i.dominio, 0) / fase5.length : 0;
  const fase4Pronta = dominioFase4 >= 2;
  const fase5Pronta = dominioFase5 >= 2;
  
  const pontuados = itens.map(i => {
    let pontos = 0;
    if (i.dueAt && new Date(i.dueAt) <= agora) pontos += 2000;
    
    const ehFase7ou8 = i.faseId === 7 || i.faseId === 8;
    const ehFase9 = i.faseId === 9;
    const ehFase3ou4 = i.faseId === 3 || i.faseId === 4;
    
    if (!fase4Pronta && ehFase7ou8) pontos += 5;
    else if (fase4Pronta && ehFase7ou8 && i.status !== 'concluido') { pontos += 500 * i.fasePrioridade; if (i.dominio <= 1) pontos += 300; }
    
    if (!fase5Pronta && ehFase9) pontos += 5;
    else if (fase5Pronta && ehFase9 && i.status !== 'concluido') pontos += 100;
    
    if (!fase4Pronta && ehFase3ou4 && i.dominio <= 1 && i.status !== 'concluido') pontos += 400;
    if (i.dominio <= 1 && i.status !== 'concluido') pontos += (4 - i.dominio) * 30 * i.fasePrioridade;
    if (i.questoesFeitas >= 5 && i.erros > 0) { const taxaErro = i.erros / i.questoesFeitas; if (taxaErro > 0.3) pontos += taxaErro * 80 * i.fasePrioridade; }
    if (i.status === 'em-andamento') pontos += 25 * i.fasePrioridade;
    if (i.questoesFeitas === 0 && i.status === 'nao-iniciado') pontos += 15 + Math.max(0, 100 - i.idx);
    if (i.status === 'revisar') pontos += 60;
    if (i.status === 'concluido' && !i.dueAt) pontos = 0;
    
    return { ...i, pontos };
  })
  .filter(i => i.pontos > 0)
  .sort((a, b) => b.pontos - a.pontos)
  .slice(0, qtd);
  
  if (pontuados.length === 0) {
    container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">üéâ Parab√©ns! Nenhuma tarefa pendente.</p>';
    return;
  }
  
  let html = '';
  pontuados.forEach((i, idx) => {
    const isRevisao = i.dueAt && new Date(i.dueAt) <= agora;
    const motivo = isRevisao ? 'üîî Revis√£o' : i.dominio <= 1 ? 'üìâ Refor√ßar' : i.erros > i.questoesFeitas * 0.3 ? '‚ùå Muitos erros' : i.status === 'em-andamento' ? 'üîÑ Continuar' : i.questoesFeitas === 0 ? 'üÜï Novo' : 'üìö Estudar';
    
    html += `
      <div class="today-item">
        <span style="font-weight: 600; color: var(--text-muted); min-width: 24px;">${idx + 1}.</span>
        <span class="dominio-badge dominio-${i.dominio}">${i.dominio}</span>
        <div class="info">
          <div class="title">${i.nome}</div>
          <div class="meta">${i.moduloNome.split(':')[0]} ‚Ä¢ ${motivo}</div>
        </div>
        <div class="actions">
          <button class="btn btn-xs btn-ghost" onclick="abrirModal('${i.id}')">‚úèÔ∏è</button>
          <button class="btn btn-xs btn-success" onclick="marcarFeitoHoje('${i.id}')">‚úì</button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function marcarFeitoHoje(id) {
  const item = estado.itens[id];
  if (!item) return;
  
  if (item.status === 'nao-iniciado') item.status = 'em-andamento';
  if (item.dueAt && new Date(item.dueAt) <= new Date()) { item.reviewCount++; item.lastReviewedAt = new Date().toISOString(); item.dueAt = null; estado.semanaDados.revisoes++; }
  item.updatedAt = new Date().toISOString();
  salvarDados();
  renderizarDashboard();
  
  if (confirm(`"${item.nome}" marcado!\n\nAgendar revis√£o em 7 dias?`)) {
    item.dueAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString();
    salvarDados();
    renderizarDashboard();
  }
}

/* TRILHA */
function renderizarTrilha() {
  const container = document.getElementById('trilha-lista');
  const busca = document.getElementById('filtro-busca').value.toLowerCase();
  const faseFiltro = document.getElementById('filtro-fase').value;
  const statusFiltro = document.getElementById('filtro-status').value;
  const dominioFiltro = document.getElementById('filtro-dominio').value;
  const fonteFiltro = document.getElementById('filtro-fonte').value;
  const ordenar = document.getElementById('filtro-ordenar').value;
  const agora = new Date();
  
  let html = '';
  const fasesFiltradas = faseFiltro ? TRILHA.filter(f => f.id === parseInt(faseFiltro)) : TRILHA;
  
  fasesFiltradas.forEach(fase => {
    let itensFase = Object.values(estado.itens).filter(i => i.faseId === fase.id);
    if (busca) itensFase = itensFase.filter(i => i.nome.toLowerCase().includes(busca) || i.moduloNome.toLowerCase().includes(busca));
    if (statusFiltro) itensFase = itensFase.filter(i => i.status === statusFiltro);
    if (dominioFiltro !== '') itensFase = itensFase.filter(i => i.dominio === parseInt(dominioFiltro));
    if (fonteFiltro) itensFase = itensFase.filter(i => i.fonte === fonteFiltro);
    
    if (ordenar === 'dominio-menor') itensFase.sort((a, b) => a.dominio - b.dominio);
    else if (ordenar === 'mais-erros') itensFase.sort((a, b) => (b.erros / (b.questoesFeitas || 1)) - (a.erros / (a.questoesFeitas || 1)));
    else if (ordenar === 'revisoes-vencidas') itensFase.sort((a, b) => { const aV = a.dueAt && new Date(a.dueAt) <= agora ? 1 : 0; const bV = b.dueAt && new Date(b.dueAt) <= agora ? 1 : 0; return bV - aV; });
    else itensFase.sort((a, b) => a.idx - b.idx);
    
    if (itensFase.length === 0 && (busca || statusFiltro || dominioFiltro || fonteFiltro)) return;
    
    const totalFase = Object.values(estado.itens).filter(i => i.faseId === fase.id).length;
    const concluidosFase = Object.values(estado.itens).filter(i => i.faseId === fase.id && i.status === 'concluido').length;
    
    html += `<div class="fase-section"><div class="fase-header ${fase.prioridade === 5 ? 'priority' : ''}" onclick="toggleFase(${fase.id})"><h3>${fase.nome} ${fase.prioridade === 5 ? '<span class="priority-badge">Prioridade BB</span>' : ''}</h3><div class="stats"><span>${concluidosFase}/${totalFase}</span><span class="toggle-icon" id="fase-toggle-${fase.id}">‚ñº</span></div></div><div class="fase-content" id="fase-content-${fase.id}">`;
    
    const modulos = {};
    itensFase.forEach(i => { if (!modulos[i.moduloId]) modulos[i.moduloId] = { nome: i.moduloNome, itens: [] }; modulos[i.moduloId].itens.push(i); });
    
    Object.entries(modulos).forEach(([modId, mod]) => {
      const totalMod = mod.itens.length;
      const conclMod = mod.itens.filter(i => i.status === 'concluido').length;
      
      html += `<div class="modulo-section"><div class="modulo-header" onclick="toggleModulo(${modId})"><h4>${mod.nome}</h4><div class="stats">${conclMod}/${totalMod} <span id="mod-toggle-${modId}">‚ñº</span></div></div><div class="modulo-content" id="mod-content-${modId}">`;
      
      mod.itens.forEach(i => {
        const statusClass = i.status === 'concluido' ? 'done' : '';
        const statusTag = { 'nao-iniciado': '<span class="tag tag-default">N√£o iniciado</span>', 'em-andamento': '<span class="tag tag-primary">Andamento</span>', 'revisar': '<span class="tag tag-warning">Revisar</span>', 'concluido': '<span class="tag tag-success">Conclu√≠do</span>' }[i.status];
        
        html += `<div class="item-row ${statusClass}" onclick="abrirModal('${i.id}')"><div class="checkbox"></div><div class="nome">${i.nome}</div><div class="fonte">${i.fonte}</div><div class="questoes"><span class="ok">‚úì${i.acertos}</span><span class="err">‚úó${i.erros}</span></div><span class="dominio-badge dominio-${i.dominio}">${i.dominio}</span>${statusTag}</div>`;
      });
      
      html += '</div></div>';
    });
    
    html += '</div></div>';
  });
  
  container.innerHTML = html || '<p style="color: var(--text-muted); text-align: center; padding: 2rem;">Nenhum item encontrado.</p>';
}

function toggleFase(id) { const c = document.getElementById(`fase-content-${id}`); const t = document.getElementById(`fase-toggle-${id}`); c.classList.toggle('open'); t.textContent = c.classList.contains('open') ? '‚ñ≤' : '‚ñº'; }
function toggleModulo(id) { const c = document.getElementById(`mod-content-${id}`); const t = document.getElementById(`mod-toggle-${id}`); c.classList.toggle('open'); t.textContent = c.classList.contains('open') ? '‚ñ≤' : '‚ñº'; }

/* MODAL */
function abrirModal(id) {
  const item = estado.itens[id];
  if (!item) return;
  
  document.getElementById('edit-id').value = id;
  document.getElementById('modal-titulo').textContent = item.nome;
  document.getElementById('edit-status').value = item.status;
  document.getElementById('edit-dominio').value = item.dominio;
  document.getElementById('edit-erro').value = item.erroTipico || '';
  
  const prereqWarning = document.getElementById('prereq-warning');
  if (item.prereq) {
    const prereqItens = Object.values(estado.itens).filter(i => i.nome.toLowerCase().includes(item.prereq.toLowerCase()));
    const prereqBaixo = prereqItens.some(p => p.dominio < 2);
    prereqWarning.style.display = prereqBaixo ? 'block' : 'none';
    prereqWarning.innerHTML = `‚ö†Ô∏è Pr√©-requisito "${item.prereq}" com dom√≠nio baixo. Considere refor√ßar antes.`;
  } else { prereqWarning.style.display = 'none'; }
  
  const infoRevisao = document.getElementById('edit-revisao-info');
  infoRevisao.textContent = item.dueAt ? `Pr√≥xima: ${new Date(item.dueAt).toLocaleDateString('pt-BR')} ‚Ä¢ ${item.reviewCount} revis√µes` : `Sem revis√£o agendada ‚Ä¢ ${item.reviewCount} revis√µes`;
  
  document.getElementById('modal-editar').classList.add('active');
}

function fecharModal() { document.getElementById('modal-editar').classList.remove('active'); }

function salvarEdicao() {
  const id = document.getElementById('edit-id').value;
  const item = estado.itens[id];
  if (!item) return;
  
  const statusAnterior = item.status;
  item.status = document.getElementById('edit-status').value;
  item.dominio = parseInt(document.getElementById('edit-dominio').value);
  item.erroTipico = document.getElementById('edit-erro').value;
  item.updatedAt = new Date().toISOString();
  
  if (statusAnterior !== 'concluido' && item.status === 'concluido') estado.semanaDados.concluidos++;
  
  salvarDados();
  fecharModal();
  renderizarTudo();
}

function agendarRevisao(dias) {
  const id = document.getElementById('edit-id').value;
  const item = estado.itens[id];
  if (!item) return;
  item.dueAt = new Date(Date.now() + dias * 24 * 60 * 60 * 1000).toISOString();
  document.getElementById('edit-revisao-info').textContent = `Pr√≥xima: ${new Date(item.dueAt).toLocaleDateString('pt-BR')} ‚Ä¢ ${item.reviewCount} revis√µes`;
  salvarDados();
}

function limparRevisao() {
  const id = document.getElementById('edit-id').value;
  const item = estado.itens[id];
  if (!item) return;
  item.dueAt = null;
  document.getElementById('edit-revisao-info').textContent = `Sem revis√£o agendada ‚Ä¢ ${item.reviewCount} revis√µes`;
  salvarDados();
}

/* EXERC√çCIOS */
function renderizarExercicios() {
  const select = document.getElementById('ex-item');
  const currentValue = select.value;
  select.innerHTML = '<option value="">Selecione...</option>';
  
  TRILHA.forEach(fase => {
    const optgroup = document.createElement('optgroup');
    optgroup.label = fase.nome;
    Object.values(estado.itens).filter(i => i.faseId === fase.id).sort((a, b) => a.idx - b.idx).forEach(i => {
      const opt = document.createElement('option');
      opt.value = i.id;
      opt.textContent = `${i.moduloNome.split(':')[0]}: ${i.nome}`;
      optgroup.appendChild(opt);
    });
    select.appendChild(optgroup);
  });
  
  if (currentValue) select.value = currentValue;
  
  const container = document.getElementById('historico-lista');
  const historico = estado.historico.slice(-20).reverse();
  
  if (historico.length === 0) { container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Nenhum registro ainda.</p>'; return; }
  
  let html = '';
  historico.forEach(h => {
    const item = estado.itens[h.itemId];
    const nome = item ? item.nome : 'Desconhecido';
    const data = new Date(h.data).toLocaleDateString('pt-BR');
    html += `<div class="history-item"><div class="date">${data}</div><div><strong>${nome}</strong>${h.erroTipico ? `<div style="font-size: 0.8rem; color: var(--text-muted);">Erro: ${h.erroTipico}</div>` : ''}</div><div class="result"><span style="color: var(--secondary);">‚úì${h.acertos}</span><span style="color: var(--danger);">‚úó${h.erros}</span></div></div>`;
  });
  container.innerHTML = html;
}

function registrarExercicio() {
  const itemId = document.getElementById('ex-item').value;
  if (!itemId) { alert('Selecione um item!'); return; }
  
  const feitas = parseInt(document.getElementById('ex-feitas').value) || 0;
  const acertos = parseInt(document.getElementById('ex-acertos').value) || 0;
  const erros = parseInt(document.getElementById('ex-erros').value) || 0;
  const erroTipico = document.getElementById('ex-erro-tipico').value.trim();
  
  const item = estado.itens[itemId];
  if (!item) return;
  
  item.questoesFeitas += feitas;
  item.acertos += acertos;
  item.erros += erros;
  item.updatedAt = new Date().toISOString();
  if (erroTipico && !item.erroTipico.includes(erroTipico)) item.erroTipico = item.erroTipico ? item.erroTipico + '; ' + erroTipico : erroTipico;
  if (item.status === 'nao-iniciado') item.status = 'em-andamento';
  
  estado.historico.push({ itemId, data: new Date().toISOString(), feitas, acertos, erros, erroTipico });
  estado.semanaDados.questoes += feitas;
  
  salvarDados();
  
  document.getElementById('ex-feitas').value = 10;
  document.getElementById('ex-acertos').value = 0;
  document.getElementById('ex-erros').value = 0;
  document.getElementById('ex-erro-tipico').value = '';
  
  renderizarExercicios();
  renderizarDashboard();
  alert('Exerc√≠cio registrado!');
}

/* METAS */
function renderizarMetas() {
  const hoje = new Date();
  const diaSemana = hoje.getDay();
  const diff = (diaSemana === 0 ? -6 : 1) - diaSemana;
  const inicioSemana = new Date(hoje);
  inicioSemana.setDate(hoje.getDate() + diff);
  const fimSemana = new Date(inicioSemana);
  fimSemana.setDate(inicioSemana.getDate() + 6);
  const formatDate = d => d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
  
  document.getElementById('week-info').innerHTML = `<span>üìÖ Semana: ${formatDate(inicioSemana)} a ${formatDate(fimSemana)}</span><span>${['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'][hoje.getDay()]}</span>`;
  
  const metas = estado.metas;
  const semana = estado.semanaDados;
  
  document.getElementById('meta-questoes-val').textContent = metas.questoes;
  document.getElementById('meta-concluidos-val').textContent = metas.concluidos;
  document.getElementById('meta-revisoes-val').textContent = metas.revisoes;
  document.getElementById('questoes-semana').textContent = semana.questoes;
  document.getElementById('concluidos-semana').textContent = semana.concluidos;
  document.getElementById('revisoes-semana').textContent = semana.revisoes;
  
  const pctQ = Math.min(100, Math.round((semana.questoes / metas.questoes) * 100));
  const pctC = Math.min(100, Math.round((semana.concluidos / metas.concluidos) * 100));
  const pctR = Math.min(100, Math.round((semana.revisoes / metas.revisoes) * 100));
  
  document.getElementById('progress-questoes').style.width = pctQ + '%';
  document.getElementById('progress-concluidos').style.width = pctC + '%';
  document.getElementById('progress-revisoes').style.width = pctR + '%';
}

/* BACKUP */
function exportarDados() {
  const dados = JSON.stringify(estado, null, 2);
  const blob = new Blob([dados], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `matematica-backup-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importarDados(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const dados = JSON.parse(e.target.result);
      if (!dados.itens) throw new Error('Arquivo inv√°lido');
      if (confirm('Isso substituir√° todos os dados atuais. Continuar?')) {
        estado = dados;
        salvarDados();
        inicializarItens();
        renderizarTudo();
        alert('Dados importados!');
      }
    } catch (err) { alert('Erro ao importar: arquivo inv√°lido.'); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function resetarDados() {
  const confirmacao = prompt('Digite "RESETAR" para confirmar:');
  if (confirmacao === 'RESETAR') {
    localStorage.removeItem('mat-bb-v3');
    estado = { itens: {}, historico: [], metas: { questoes: 50, concluidos: 6, revisoes: 14 }, semanaDados: { inicio: null, questoes: 0, concluidos: 0, revisoes: 0 } };
    inicializarItens();
    renderizarTudo();
    alert('Dados resetados!');
  }
}

/* EVENTOS */
document.getElementById('modal-editar').addEventListener('click', function(e) { if (e.target === this) fecharModal(); });
document.addEventListener('keydown', function(e) { if (e.key === 'Escape') fecharModal(); });
document.addEventListener('DOMContentLoaded', inicializar);
</script>

</body>
</html>
